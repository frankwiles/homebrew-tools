name: Update kube-anypod Formula

on:
  workflow_dispatch:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'

permissions:
  contents: write

jobs:
  update-kube-anypod:
    runs-on: macos-latest
    steps:
      - name: Checkout tap repo
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false

      - name: Fetch latest release from kube-anypod repo
        id: get-latest
        run: |
          LATEST_TAG=$(curl -s "https://api.github.com/repos/frankwiles/kube-anypod/releases/latest" | jq -r '.tag_name')
          LATEST_VERSION="${LATEST_TAG#v}"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Check current version in formula
        id: check-current
        run: |
          CURRENT_VERSION=$(grep 'version "' Formula/kube-anypod.rb | sed 's/.*"\(.*\)".*/\1/')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Download binaries and calculate checksums
        if: steps.get-latest.outputs.version != steps.check-current.outputs.current
        id: checksums
        run: |
          VERSION="${{ steps.get-latest.outputs.version }}"
          TAG="${{ steps.get-latest.outputs.tag }}"

          # Download ARM binary
          curl -Ls "https://github.com/frankwiles/kube-anypod/releases/download/${TAG}/anypod-macos-aarch64" -o /tmp/anypod-aarch64
          ARM_SHA=$(shasum -a 256 /tmp/anypod-aarch64 | awk '{print $1}')

          # Download Intel binary
          curl -Ls "https://github.com/frankwiles/kube-anypod/releases/download/${TAG}/anypod-macos-x86_64" -o /tmp/anypod-x86_64
          INTEL_SHA=$(shasum -a 256 /tmp/anypod-x86_64 | awk '{print $1}')

          echo "arm_sha=$ARM_SHA" >> $GITHUB_OUTPUT
          echo "intel_sha=$INTEL_SHA" >> $GITHUB_OUTPUT

      - name: Update formula
        if: steps.get-latest.outputs.version != steps.check-current.outputs.current
        run: |
          VERSION="${{ steps.get-latest.outputs.version }}"
          TAG="${{ steps.get-latest.outputs.tag }}"
          ARM_SHA="${{ steps.checksums.outputs.arm_sha }}"
          INTEL_SHA="${{ steps.checksums.outputs.intel_sha }}"

          cat > Formula/kube-anypod.rb << 'EOF'
          # typed: false
          # frozen_string_literal: true

          class KubeAnypod < Formula
            desc "Return the name of any pod from a given Deployment, StatefulSet, or DaemonSet"
            homepage "https://github.com/frankwiles/kube-anypod"
            version "#{VERSION}"
            license "BSD-3-Clause"
            depends_on :macos

            if Hardware::CPU.intel?
              url "https://github.com/frankwiles/kube-anypod/releases/download/#{TAG}/anypod-macos-x86_64"
              sha256 "#{INTEL_SHA}"

              def install
                bin.install "anypod-macos-x86_64" => "anypod"
              end
            end

            if Hardware::CPU.arm?
              url "https://github.com/frankwiles/kube-anypod/releases/download/#{TAG}/anypod-macos-aarch64"
              sha256 "#{ARM_SHA}"

              def install
                bin.install "anypod-macos-aarch64" => "anypod"
              end
            end

            test do
              system "#{bin}/anypod", "--help"
            end
          end
          EOF

          # Use envsubst to replace variables
          envsubst < Formula/kube-anypod.rb > /tmp/kube-anypod.rb
          mv /tmp/kube-anypod.rb Formula/kube-anypod.rb
        env:
          VERSION: ${{ steps.get-latest.outputs.version }}
          TAG: ${{ steps.get-latest.outputs.tag }}
          ARM_SHA: ${{ steps.checksums.outputs.arm_sha }}
          INTEL_SHA: ${{ steps.checksums.outputs.intel_sha }}

      - name: Create Pull Request
        if: steps.get-latest.outputs.version != steps.check-current.outputs.current
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Update kube-anypod to v${{ steps.get-latest.outputs.version }}"
          body: |
            Automated update for kube-anypod v${{ steps.get-latest.outputs.version }}
          committer: GitHub <noreply@github.com>
          branch: "update-kube-anypod-${{ steps.get-latest.outputs.version }}"
          delete-branch: true
